---
title: "GEN-I: Nelinearne transakcije"
subtitle: "Projekt pri predmetu: Matematika z racunalnikom"
author: "Anja Trobec"
date: "Maj 2022"
output:
  html_document:
printresults: hide
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
library(gridExtra)
library(coda)
library(knitr)
```

<center> <h2> NAVODILA ZA IZDELAVO PROJEKTA </h2> </center>

Imamo mesecno nelinearno transakcijo za elektricno energijo, kjer se lahko znotraj dolocenih omejitev za vsako uro znotraj meseca dobave lastnik opcijskosti odloci, koliko el. energije bo prevzeli/dobavil. Ovrednotimo jo napram mnozici cenovnih scenarijev, tako da za vsak cenovni scenarij dobimo njen profit. Cenovni scenariji so mozne prihodnje cene dobave, oblikovani tako, da ustrezno popisejo verjetnostno porazdelitev prihodnje cene v smislu njene srednje vrednosti in standardne deviacije (volatilnosit). Za to transakcijo zelimo poiskati njen ekvivalent standardne Evropske opcije. Kaksni so parametri ekvivalenta te opcije, kot kolicina, cena (strike), stran (nakup/prodaja) in tip (call/put) opcije?


<center> <h2>  1. TEORETICNI UVOD </h2> </center>

Moja glavna naloga je poiskati Evropsko opcijo, ki se najbolje pribliza transakciji predstavljeni v podatkih. Vhodni podatki so pari, v katerih prva komponenta predstavlja ceno in druga profit pri dani ceni. 

Evropski opciji, ki bo ekvivalentna transakciji, je potrebno dolociti parametre. To so:

* v naprej dogovorjena izvrsilna cena (angl. strike price), 
* kolicina in 
* placana ali prejeta premija.

Dolociti moramo **tip opcije**. Lahko gre za:

* **nakupno opcijo** (*angl. call option*) ali 
* **prodajno opcijo** (*angl. put option*). 

Znotraj obeh tipov opcij, locimo se pozicijo, ki jo zavzamemo. Lahko smo v vlogi izdajatelja opcije (*angl. option writer*) in v tem primeru **opcijo prodamo** ali pa **opcijo kupimo** in s tem postanemo lastnik opcije (*angl. option buyer*).

S tem smo prisli do stirih razlicnih situacij, med katerimi iscemo tisto, ki najbolje opise dano transakcijo. Podrobneje si poglejmo vsako izmed moznih izbir.



<h4> 1. NAKUP EVROPSKE NAKUPNE OPCIJE </h4>

Nakupna opcija podeljuje lastniku pravico za nakup dolocenega financnega instrumenta (angl. *underlying asset*) po vnaprej doloceni izvrsilni ceni na dolocen dan (kadar govorimo o Evropski opciji) ali do dolocenega dne (kadar imamo opravka z Amerisko opcijo). Lastniku nakupna opcija ne predstavlja obveznosti, pac pa priloznost (recemo, da mu nudi opcijskost), da opcijo izvrsi v primeru, ce cena financnega instrumenta na trgu naraste. Za nakupno opcijo recemo, da je:

* **in the money** - ce je cena financnega instrumenta nad izvrsilno ceno,
* **at the money** - ce sta cena financnega instrumenta in izvrsilna cena enaki,
* **put of the money** - ce je cena financnega instumenta pod izvrsilno ceno.

Opazimo, da ima kupec evropske nakupne opcije neomejen dobicek in na drugi strani izgubo omejeno s premijo. Drugace povedano, najvec kar lahko kupec izgubi je premija, ki jo placa za nakup opcije v primeru, da opcije ne izvrsi. 




 <h4> 2. NAKUP EVROPSKE PRODAJNE OPCIJE </h4>

Prodajna opcija podeljuje lastniku pravico za prodajo dolocenega financnega instrumenta (angl. *underlying asset*) po vnaprej doloceni izvrsilni ceni na dolocen dan (kadar govorimo o Evropski opciji) ali do dolocenega dne (kadar imamo opravka z Amerisko opcijo). Lastniku nakupna opcija ne predstavlja obveznosti, pac pa priloznost (recemo, da mu nudi opcijskost), da opcijo izvrsi v primeru, ce cena financnega instrumenta na trgu pade. Za nakupno opcijo recemo, da je:

* **in the money** - ce je cena financnega instrumenta pod izvrsilno ceno,
* **at the money** - ce sta cena financnega instrumenta in izvrsilna cena enaki,
* **put of the money** - ce je cena financnega instumenta nad izvrsilno ceno.

Enako kot pri nakupu evropske nakupne opcije lahko opazimo, da ima kupec evropske prodajne opcije neomejen dobicek in na drugi strani izgubo omejeno s premijo. Drugace povedano, najvec kar lahko kupec izgubi je premija, ki jo placa za nakup opcije v primeru, da opcije ne izvrsi. 




<h4> 3. PRODAJA EVROPSKE NAKUPNE OPCIJE </h4>

Zdaj se postavimo v vlogo izdajatelja opcije. S tem ko opcijo prodamo, se zavezemo k izplacilu v primeru, da kupec opcijo izvrsi. Torej je v tem primeru dobicek navzgor omejen s prejeto premijo in izguba navzdol neomejena v primeru, da cena na trgu naraste. 




<h4> 4. PRODAJA EVROPSKE PRODAJNE OPCIJE </h4>

Zadnji scenarij pa je prodaja evropske prodajne opcije. Izdajatelj prodajne opcije opcijo proda, zanjo prejme premijo in se zaveze k izplacilu v primeru, da lastnik opcijo izvrsi. Ponovno je njegova izguba navzdol neomejena, medtem ko je dobicek navzgor omejen s prejeto premijo.


Poglejmo si izplacila vseh stirih opcij na spodnji sliki. 
```{r, echo=FALSE, eval=TRUE, results="markup", fig.align="center",results='hide'}
# VALUE OF EU PUT OPTION
putV <- function(S,K) pmax(0,K-S)
putbuyPayoff <- function(S,K,premium) pmax(0-abs(premium),K-S-abs(premium))

# VALUE OF EU CALL OPTION
callV <- function(S,K) pmax(0,S-K)
callbuyPayoff <- function(S,K,premium) pmax(0-abs(premium),S-K-abs(premium))

# VALUE OF EU PUT OPTION
putV <- function(S,K) pmin(0,S-K)
putsellPayoff <- function(S,K,premium) pmin(0+abs(premium),S-K+abs(premium))

# VALUE OF EU CALL OPTION
callV <- function(S,K) pmin(0,K-S) - pmax(0,S-K)
callsellPayoff <- function(S,K,premium) pmin(0,K-S) - pmax(0,S-K) + abs(premium)
```

```{r, echo=FALSE, eval=TRUE, results="markup", fig.align="center",results='hide'}
par(mfrow = c(2,2))

x <- 0:50
K <- 20
premija <- -5

plot(x,callbuyPayoff(x,K,premija), type="l",lwd = 2, xlab = "Cena opcije", ylab = "Vrednost opcije", main = "Nakup evropske nakupne opcije", xlim = c(-7,40))
abline(h = premija, lty= 'dashed')

plot(x,putbuyPayoff(x,K,premija), type="l",lwd = 2, xlab = "Cena opcije", ylab = "Vrednost opcije", main = "Nakup evropske prodajne opcije", xlim = c(-7,40))
abline(h = premija, lty= 'dashed')

premija <- 5

plot(x,callsellPayoff(x,K,premija), type="l",lwd = 2, xlab = "Cena opcije", ylab = "Vrednost opcije", main = "Prodaja evropske nakupne opcije", xlim = c(-7,40))
abline(h = premija, lty= 'dashed')

plot(x,putsellPayoff(x,K,premija), type="l",lwd = 2, xlab = "Cena opcije", ylab = "Vrednost opcije", main = "Prodaja evropske prodajne opcije", xlim = c(-7,40))
abline(h = premija, lty= 'dashed')
```



```{r, echo=FALSE, eval=TRUE, results="markup", fig.align="center"}
#getwd()
#setwd("C:/Users/aanja/OneDrive/Dokumenti/fmf/magisterski studij/matematika z racunalnikom/Nelinearne-transakcije/projekt")
```

```{r, echo=FALSE, eval=TRUE, results="markup", fig.align="center",results='hide'}
# read data
df <- read.csv("podatki.csv", sep=';', header = FALSE, stringsAsFactors=FALSE)
colnames(df) <- c('Price','Profit')
df

price <- as.numeric(gsub(",", ".", df$Price))
profit <- as.numeric(gsub(",", ".", df$Profit))
profit <- profit/1000
```

```{r, echo=FALSE, eval=TRUE, results="markup", fig.align="center"}
#plot data: PRICE vs PROFIT
plot(x = price,
     y = profit,
     xlab = "Price",
     ylab = "Profit",
     main = "Price vs Profit",
     pch = 20, cex=1.5)
abline(h = 0, lty='dashed')
```

Iz slike je jasno razvidno, da gre za nakup evropske prodajne opcije. Za dolocitev izvrsilne cene, kolicine in premije moramo najti ustrezno aproksimacijo z dvema premicama. Ti dve premici imata doloceno obliko, ena izmed njiju je vselej vodoravna, druga pa posevna s pozitivnim ali negativnim naklonom, seveda odvisno od vrste opcije.



```{r, echo=FALSE, eval=TRUE, results="markup", fig.align="center",results='hide'}
#main function for EU option aproximation

opt_fit <- function(price, profit){
  if (cor(price, profit) < 0){
    #nakup put opcije (3) ali prodaja nakupne opcije (2)
    
    meja <- length(price)/4
    povpr1 <- mean(profit[1:meja])
    er1 <- 0
    
    for (i in 1:meja){
      er1 <- er1 + (profit[i] - povpr1)^2}
    
    povpr1 <- mean(profit[(length(price)-meja):length(price)])
    er2 <- 0
    for (i in (length(price)-meja):length(price)){
      er2 <- er2 + (profit[i] - povpr1)^2}

    
    #NAKUP PUT OPCIJE
    if (er1 > er2){
      komentar <- paste("Gre za nakup put opcije.")
      print(komentar)
      
      odstopanje1 <- rep(0,length(price)) #odstopanje pri aproksimaciji z vodoravno premico
      odstopanje2 <- rep(0,length(price)) #odstopanje pri aproksimaciji z linearno regresijo (posevni del)
      #odstopanja <- rep(0,length(price)) #skupno odstopanje
      najboljsi_K = 0
      
      
      for (K in 1:length(price)){
        #VODORAVNA PREMICA
        premica1 <- profit[K]
        napaka1 <- rep(0,length(price[K:length(profit)]))
        profiti <- profit[K:length(profit)]
        for (i in 1:length(napaka1)){
          napaka1[i] <- (((premica1 - profiti[i])^2))
        }
        odstopanje1[K] <- sum(napaka1)
        
        
        #POsEVNA PREMICA
        premica2 <- lm(profit[1:K] ~ price[1:K])
        odstopanje2[K] <- deviance(premica2)
        odstopanje2[K]
        
        
        # #ce pokaze kako vrednost 0 
        # if(odstopanje1[K] == 0){
        #   odstopanje1[K] = 5*10^10
        # }
        # if(odstopanje2[K] == 0){
        #   odstopanje2[K] = 5*10^10
        # }
      }
      
      odstopanja <- odstopanje1 + odstopanje2
      
      najboljsi_K <- which(min(odstopanja) == odstopanja)
      premica1 <- mean(profit[najboljsi_K:length(profit)])
      abline(h = profit[najboljsi_K], col = 'red', lwd=2)
      premica2 <- lm(profit[1:najboljsi_K] ~ price[1:najboljsi_K])
      abline(premica2$coefficients[1],premica2$coefficients[2], col = 'dark blue',lwd=2)
      najboljsi_K
      
      strike_price = price[najboljsi_K]
      premija = profit[najboljsi_K]
      komentar <- paste("Priblizek za izvrsilno ceno opcije je ", as.character(strike_price), ", za premijo pa ", as.character(premija), ".",sep="")
      print(komentar)
        
      }
      
  

    #PRODAJA CALL OPCIJE
    if (er2 > er1){
      komentar <- paste("Gre za prodajo call opcije.")
      print(komentar)

      for (K in 1:(length(price))){
        odstopanje1 <- rep(0,length(price)) #odstopanje pri aproksimaciji z vodoravno premico
        odstopanje2 <- rep(0,length(price)) #odstopanje pri aproksimaciji z linearno regresijo (posevni del)
        #odstopanja <- rep(0,length(price)) #skupno odstopanje
        najboljsi_K = 0

        #VODORAVNA PREMICA
        premica1 <- profit[K]
        napaka1 <- rep(0,length(price[1:K]))
        profiti <- profit[1:K]
        for (i in 1:length(napaka1)){
          napaka1[i] <- (((premica1 - profiti[i])^2))
        }
        odstopanje1[K] <- sum(napaka1)
        
        
        #POsEVNA PREMICA
        premica2 <- lm(profit[K:length(price)] ~ price[K:length(price)])
        odstopanje2[K] <- deviance(premica2)
        odstopanje2[K]

      }

      odstopanja <- odstopanje1 + odstopanje2
      najboljsi_K <- which(min(odstopanja) == odstopanja)
      premica1 <- profit[najboljsi_K]
      abline(h = profit[najboljsi_K], col = 'red')
      premica2 <- lm(profit[najboljsi_K:length(price)] ~ price[najboljsi_K:length(price)])
      abline(premica2$coefficients[1],premica2$coefficients[2], col = 'dark blue')
      najboljsi_K

      strike_price = price[najboljsi_K]
      premija = profit[najboljsi_K]
      komentar <- paste("Priblizek za izvrsilno ceno opcije je ", as.character(strike_price), ", za premijo pa ", as.character(premija), ".",sep="")
      print(komentar)
      
    }

    

  }
  if (cor(price, profit) > 0){
    #nakup call opcije ali prodaja put opcije
    #Ugotovi za katero gre:
    meja <- length(price)/4
    povpr1 <- mean(profit[1:meja])
    er1 <- 0
    
    for (i in 1:meja){
      er1 <- er1 + (profit[i] - povpr1)^2
    }
    
    povpr1 <- mean(profit[(length(price)-meja):length(price)])
    er2 <- 0
    for (i in (length(price)-meja):length(price)){
      er2 <- er2 + (profit[i] - povpr1)^2
    }
    
    
    #PRODAJA PUT OPCIJE
    if (er1 > er2){
      komentar <- paste("Gre za prodajo put opcije.")
      print(komentar)
      
      odstopanje1 <- rep(0,length(price)) #odstopanje pri aproksimaciji z vodoravno premico
      odstopanje2 <- rep(0,length(price)) #odstopanje pri aproksimaciji z linearno regresijo (posevni del)
      #odstopanja <- rep(0,length(price)) #skupno odstopanje
      najboljsi_K = 0
      
      
      for (K in 1:length(price)){
        #VODORAVNA PREMICA
        premica1 <- mean(profit[K:length(profit)])
        napaka1 <- rep(0,length(price[K:length(profit)]))
        profiti <- profit[K:length(profit)]
        for (i in 1:length(napaka1)){
          napaka1[i] <- (((premica1 - profiti[i])^2))
        }
        odstopanje1[K] <- sum(napaka1)
        
        
        #POsEVNA PREMICA
        premica2 <- lm(profit[1:K] ~ price[1:K])
        odstopanje2[K] <- deviance(premica2)
        odstopanje2[K]
        
        
        # #ce pokaze kako vrednost 0 
        # if(odstopanje1[K] == 0){
        #   odstopanje1[K] = 5*10^10
        # }
        # if(odstopanje2[K] == 0){
        #   odstopanje2[K] = 5*10^10
        # }
      }
      
      odstopanja <- odstopanje1 + odstopanje2
      
      najboljsi_K <- which(min(odstopanja) == odstopanja)
      premica1 <- mean(profit[najboljsi_K:length(profit)])
      abline(h = profit[najboljsi_K], col = 'red')
      premica2 <- lm(profit[1:najboljsi_K] ~ price[1:najboljsi_K])
      abline(premica2$coefficients[1],premica2$coefficients[2], col = 'dark blue')
      najboljsi_K
      
      strike_price = price[najboljsi_K]
      premija = profit[najboljsi_K]
      komentar <- paste("Priblizek za izvrsilno ceno opcije je ", as.character(strike_price), ", za premijo pa ", as.character(premija), ".",sep="")
      print(komentar)
      
    }
    
    
    
    #NAKUP CALL OPCIJE
    if (er2 > er1){
      komentar <- paste("Gre za nakup call opcije.")
      print(komentar)
      
      for (K in 1:(length(price))){
        odstopanje1 <- rep(0,length(price)) #odstopanje pri aproksimaciji z vodoravno premico
        odstopanje2 <- rep(0,length(price)) #odstopanje pri aproksimaciji z linearno regresijo (posevni del)
        # odstopanja <- rep(0,length(price)) #skupno odstopanje
        najboljsi_K = 0
        
        #VODORAVNA PREMICA
        premica1 <- mean(profit[1:K])
        napaka1 <- rep(0,length(price[1:K]))
        profiti <- profit[1:K]
        for (i in 1:length(napaka1)){
          napaka1[i] <- (((premica1 - profiti[i])^2))
        }
        odstopanje1[K] <- sum(napaka1)
        
        
        #POsEVNA PREMICA
        premica2 <- lm(profit[K:length(price)] ~ price[K:length(price)])
        odstopanje2[K] <- deviance(premica2)
        odstopanje2[K]
        
      }
      
      odstopanja <- odstopanje1 + odstopanje2
      najboljsi_K <- which(min(odstopanja) == odstopanja)
      premica1 <- profit[najboljsi_K]
      abline(h = profit[najboljsi_K], col = 'red')
      premica2 <- lm(profit[najboljsi_K:length(price)] ~ price[najboljsi_K:length(price)])
      abline(premica2$coefficients[1],premica2$coefficients[2], col = 'dark blue')
      najboljsi_K
      
      strike_price = price[najboljsi_K]
      premija = profit[najboljsi_K]
      komentar <- paste("Priblizek za izvrsilno ceno opcije je ", as.character(strike_price), ", za premijo pa ", as.character(premija), ".",sep="")
      print(komentar)
      
    }
  }
}
```

```{r, echo=FALSE, eval=TRUE, results="markup", fig.align="center"}
#1. podatki, nakup prodajne opcije
df <- read.csv("podatki.csv", sep=';', header = FALSE, stringsAsFactors=FALSE)
colnames(df) <- c('Price','Profit')
if (df$Price[2] > df$Price[3]){
  df <- df[order(df$Price),]} #podatke uredim po cene padajoce
df
price <- as.numeric(gsub(",", ".", df$Price))
profit <- as.numeric(gsub(",", ".", df$Profit))
profit <- profit / 1000

korelacija1 <- cor(price, profit)
korelacija1
#narisi graf
plot(x = price,
     y = profit,
     xlab = "Cena (v eur)",
     ylab = "Profit (v tisoc eur)",
     main = "Cena vs Profit",
     pch = 20, cex=1.5)
abline(h = 0, lty='dashed')

opt_fit(price,profit)
```



