---
title: "GEN-I: Nelinearne transakcije"
subtitle: "Poroèilo"
author: "Anja Trobec"
date: "April 2022"
output:
  html_document:
  printresults: hide
editor_options:
  chunk_output_type: console
---
  
```{r setup, include=FALSE}
library(tidyverse)
library(gridExtra)
library(coda)
library(knitr)
library(extrafont)
```

<center> <h2> NAVODILA ZA IZDELAVO PROJEKTA </h2> </center>
  
  Imamo meseèno nelinearno transakcijo za elektrièno energijo, kjer se lahko znotraj doloèenih omejitev za vsako uro znotraj meseca dobave lastnik opcijskosti odloèi, koliko el. energije bo prevzeli/dobavil. Ovrednotimo jo napram množici cenovnih scenarijev, tako da za vsak cenovni scenarij dobimo njen profit. Cenovni scenariji so možne prihodnje cene dobave, oblikovani tako, da ustrezno popišejo verjetnostno porazdelitev prihodnje cene v smislu njene srednje vrednosti in standardne deviacije (volatilnosit). Za to transakcijo želimo poiskati njen ekvivalent standardne Evropske opcije. Kakšni so parametri ekvivalenta te opcije, kot kolièina, cena (strike), stran (nakup/prodaja) in tip (call/put) opcije?
  
  <center> <h2> PROJEKT </h2> </center>
  
  <h3> 1. TEORETIÈNI UVOD </h3>
  
Moja naloga je poiskati Evropsko opcijo, ki najboljše opiše nelinearno transakcijo predstavljeno v podatkih. Vhodni podatki so pari, v katerih prva komponenta predstavlja ceno (*$S_t$* - *cena ob èasu t*) in druga komponenta izplaèilo pri dani ceni (*$V_t$* - *vrednost opcije v èasu t*). Cena je izrazena v EUR/MWh, izplaèilo pa v EUR.
  
  $$(S_t,V_t) $$

Iskani Evropski opciji, ki bo ekvivalentna transakciji, je potrebno doloèiti najslednje parametre:
  
* izvršilno cena ($K$, *angl. strike price*), 
* kolièino ($Q$) in 
* plaèano ali prejeto premijo (*angl. option premium*).

Doloèiti je potrebno tudi **tip opcije**. Lahko gre za:
  
* **call opcijo** (*angl. call option*) ali 
* **put opcijo** (*angl. put option*). 

Znotraj obeh tipov opcij, loèimo še dve poziciji, kateri lahko zavzamemo. Lahko smo v vlogi izdajatelja opcije (*angl. option writer*) in v tem primeru **opcijo prodamo** ali pa **opcijo kupimo** in s tem postanemo lastnik opcije (*angl. option buyer*).

To nas pripelje do štirih razliènih situacij, med katerimi išèemo tisto, ki najbolje opiše dano transakcijo. Podrobneje si oglejmo vsako izmed možnih izbir.

<br>
  
  <h4> 1. NAKUP EVROPSKE CALL OPCIJE </h4>
  
 **Call opcija** podeljuje **lastniku (kupcu opcije)** pravico za nakup doloèenega finanènega inštrumenta (*angl. underlying asset*) po vnaprej doloèeni izvršilni ceni na dolocen dan (kadar govorimo o Evropski opciji) ali do doloèenega dne (kadar imamo opravka z Ameriško opcijo). Lastniku call opcija ne predstavlja obveznosti, paè pa priložnost (reèemo, da mu nudi opcijskost), da opcijo izvrši v primeru, èe cena finanènega inštrumenta na trgu naraste. Za call opcijo reèemo, da je:
  
* **in the money** - kadar je cena finanènega inštrumenta nad izvršilno ceno,
* **at the money** - kadar sta cena finanènega inštrumenta in izvršilna cena enaki,
* **put of the money** - kadar je cena financnega instumenta pod izvršilno ceno.

Opazimo, da ima kupec evropske call opcije  **neomejen dobièek** in na drugi strani  **izgubo omejeno s plaèano premijo**. Drugaèe povedano, najveè kar lahko kupec izgubi je premija, ki jo plaèa za nakup opcije v primeru, da opcije ne izvrši. 

Formula za vrednotenje izplaèil opcije ob èasu t: 
  $$ V_t = max(S_t-K,0) = (S_t - K)^+ $$
  
  <br>
  
  <h4> 2. NAKUP EVROPSKE PUT OPCIJE </h4>
  
 **Put opcija** podeljuje  **lastniku (kupcu opcije) ** pravico za prodajo doloèenega finanènega inštrumenta po vnaprej doloèeni izvršilni ceni na doloèen dan ali do doloèenega dne. Lastniku call opcija ne predstavlja obveznosti, paè pa priložnost (reèemo, da mu nudi opcijskost), da opcijo izvrši v primeru, èe cena finanènega inštrumenta na trgu pade. Za call opcijo reèemo, da je:
  
* **in the money** - kadar je cena finanènega inštrumenta pod izvršilno ceno,
* **at the money** - kadar sta cena finanènega inštrumenta in izvršilna cena enaki,
* **put of the money** - kadar je cena financnega instumenta nad izvršilno ceno.

Enako kot pri nakupu evropske call opcije lahko opazimo, da ima kupec evropske put opcije **neomejen dobicek** in na drugi strani  **izgubo omejeno s plaèano premijo**. Drugaèe povedano, najveè kar lahko kupec izgubi je premija, ki jo plaèa za nakup opcije v primeru, da opcije ne izvrši. 
Formula za vrednotenje izplacil opcije ob èasu t: 
  $$ V_t = max(K-S_t,0) = (K-S_t)^+ $$
  
  <br>
  
  
  <h4> 3. PRODAJA EVROPSKE CALL OPCIJE </h4>
  
Zdaj se postavimo v vlogo izdajatelja opcije. S tem ko **opcijo prodamo**, zanjo **prejmemo premijo** in se zavežemo k izplaèilu v primeru, da kupec opcijo ob dospelosti izvrši. Torej je v primeru prodaje call opcije **dobicek navzgor omejen s prejeto premijo** in **izguba navzdol neomejena** (do velike izgube pride, èe cena finanènega inštrumenta na trgu naraste). 

Formula za vrednotenje izplaèil opcije ob èasu t: 
   $$ V_t = premija - max(S_t-K,0) = premija - (S_t - K)^+ $$
  
  <br>
  
  <h4> 4. PRODAJA EVROPSKE PUT OPCIJE </h4>
  
Zadnji scenarij pa je prodaja evropske put opcije. Kot izdajatelj put opcije, **opcijo prodamo**, zanjo **prejmemo premijo** in se zavežemo k izplaèilu v primeru, da lastnik opcijo ob dospelosti izvrši. Ponovno je **izguba navzdol neomejena**, medtem ko je **dobièek navzgor omejen s prejeto premijo**.

Formula za vrednotenje izplaèil opcije ob èasu t: 
  $$ V_t = min(S_t-K,0) = (S_t-K)^-  $$
  
  
Za lažje razumevanje opisanega, si oglejmo spodnjo sliko. Predpostavila sem naslednje parametre:

* $K = 20$ 
* premija = $5$

```{r, echo=FALSE, eval=TRUE, results="markup", fig.align="center",results='hide'}
# VALUE OF EU PUT OPTION
putV <- function(S,K) pmax(0,K-S)
putbuyPayoff <- function(S,K,premium) pmax(0-abs(premium),K-S-abs(premium))

# VALUE OF EU CALL OPTION
callV <- function(S,K) pmax(0,S-K)
callbuyPayoff <- function(S,K,premium) pmax(0-abs(premium),S-K-abs(premium))

# VALUE OF EU PUT OPTION
putV <- function(S,K) pmin(0,S-K)
putsellPayoff <- function(S,K,premium) pmin(0+abs(premium),S-K+abs(premium))

# VALUE OF EU CALL OPTION
callV <- function(S,K) pmin(0,K-S) - pmax(0,S-K)
callsellPayoff <- function(S,K,premium) pmin(0,K-S) - pmax(0,S-K) + abs(premium)
```

```{r, echo=FALSE, eval=TRUE, results="markup", fig.align="center",results='hide'}
par(mfrow = c(2,2))

x <- seq(from = 0, to = 40, by = 0.05)
K <- 20
premija <- -5

plot(x,callbuyPayoff(x,K,premija), type="l",lwd = 2, xlab = "Cena opcije", ylab = "Vrednost opcije", main = "Nakup call opcije", xlim = c(-7,40))
abline(h = premija, lty= 'dashed')

plot(x,putbuyPayoff(x,K,premija), type="l",lwd = 2, xlab = "Cena opcije", ylab = "Vrednost opcije", main = "Nakup put opcije", xlim = c(-7,40))
abline(h = premija, lty= 'dashed')

premija <- 5

plot(x,callsellPayoff(x,K,premija), type="l",lwd = 2, xlab = "Cena opcije", ylab = "Vrednost opcije", main = "Prodaja call opcije", xlim = c(-7,40))
abline(h = premija, lty= 'dashed')

plot(x,putsellPayoff(x,K,premija), type="l",lwd = 2, xlab = "Cena opcije", ylab = "Vrednost opcije", main = "Prodaja put opcije", xlim = c(-7,40))
abline(h = premija, lty= 'dashed')
```



<h3> 2. PRISTOP K REŠEVANJU PROBLEMA </h3>
  
Reševanja problema se je najbolj smiselno lotiti na naèin, da vhodne podatke grafièno upodobimo. V nekaterih primerih bo že iz zaèetne slike jasno, katero izmed štirih situacij bomo uporabili za aproksimacijo. 

Primer 'jasne zaèetne slike' je prikazan na spodnjem grafu.


```{r, echo=FALSE, eval=TRUE, results="markup", fig.align="center",results='hide'}
# read data
df <- read.csv("podatki.csv", sep=';', header = FALSE, stringsAsFactors=FALSE)
colnames(df) <- c('Price','Profit')
df

price <- as.numeric(gsub(",", ".", df$Price))
profit <- as.numeric(gsub(",", ".", df$Profit))
```

```{r, echo=FALSE, eval=TRUE, results="markup", fig.align="center"}
#plot data: PRICE vs PROFIT
plot(x = price,
     y = profit,
     xlab = "Cena (v EUR/MWh)",
     ylab = "Profit (v EUR)",
     main = "Nakup EU put opcije",
     pch = 20, cex=1.5)
abline(h = 0, lty='dashed')
```

Hitro razberemo, da gre za **nakup evropske put opcije**. 
Preostane nam le še doloèitev parametrov. Doloèiti moramo izvršilno ceno ($K$), kolièino ($Q$) in premijo (*premium*). Kako to najlažje storimo?
  
Oèitno je, da so vsi štirje tipi opcij sestavljeni iz dveh premic. Ena izmed premic je vselej vzporedna x osi, druga pa ima bodisi pozitiven bodisi negativen naklon. Ideja je, da **vsako vhodno transakcijo aproksimiramo s kombinacijo teh dveh premic**. S tem, ko doloèimo ustrezno kombinacijo premic, lahko hitro ugotovimo, za katero vrsto opcije in tip pozicije gre. Nadaljno lahko iz smernega koeficienta in zaèetne vrednosti izbranih optimalnih premic, doloèimo iskane parametre. 

Premica, ki bo vselej vodoravna doloèa premijo:
$$ y = 	premija $$
*Opomba*: premija je lahko negativna ali pozitivna, odvisno katero pozicijo v opciji zavzamemo.


Premica s pozitivnim ali negativnim naklonom doloèa kolièino (Q):
  
$$ y = 	Q * S_t + n$$
  
  
Iz preseèišèa zgornjih dveh premic dobimo izvršilno ceno (K):
  
  $$ K = \frac{premija - n}{Q} $$
  
*Opomba*: predznak je odvisen od predznaka premije.  

Konèno iz vsega opisanega sestavimo algoritem, ki bo izraèunal iskane parametre in odgovoril na vprasanje za kateri tip in pozicijo v opciji gre. 



<h3> 3. ALGORITEM </h3>

Algoritem sprejme csv datoteko sestavljeno iz dveh stolpcev. V prvem stolpcu najdemo ceno finanènega inštrumenta izrazeno v EUR/MWh in v drugem stolpcu najdemo izplaèilo pri dani ceni, izrazeno v EUR. Algoritem podatke prebere in najprej doloèi, za katero vrsto opcije gre. To stori na naslednji nacin:
  
  1. Algoritem **izraèuna korelacijo** med podatki in s tem izbiro med štirimi možnostmi prevede na izbiro med spodnjima dvema:
  
* èe je **korelacija negativna**, takoj vemo, da gre za *nakup put opcije* ali za *prodajo call opcije*. 

```{r, echo=FALSE, eval=TRUE, results="markup", fig.align="center",results='hide', out.height= '50%'}
par(mfrow = c(1,2))

x <- seq(from = 0, to = 40, by = 0.05)
K <- 20
premija <- -5

plot(x,putbuyPayoff(x,K,premija), type="l",lwd = 2, xlab = "Cena opcije", ylab = "Vrednost opcije", main = "Nakup put opcije", xlim = c(-7,40))
abline(h = premija, lty= 'dashed', col='blue')
abline(h = 0, lty= 'dashed')

premija <- 5

plot(x,callsellPayoff(x,K,premija), type="l",lwd = 2, xlab = "Cena opcije", ylab = "Vrednost opcije", main = "Prodaja call opcije", xlim = c(-7,40))
abline(h = premija, lty= 'dashed', col='blue')
abline(h = 0, lty= 'dashed')
```

* èe je **korelacija pozitivna**, pa nam preostaneta ali *prodaja put opcije* ali pa *nakup call opcije*. 

```{r, echo=FALSE, eval=TRUE, results="markup", fig.align="center",results='hide', out.height = '50%'}
par(mfrow = c(1,2))

x <- seq(from = 0, to = 40, by = 0.05)
K <- 20
premija <- -5

plot(x,callbuyPayoff(x,K,premija), type="l",lwd = 2, xlab = "Cena opcije", ylab = "Vrednost opcije", main = "Nakup call opcije", xlim = c(-7,40))
abline(h = premija, lty= 'dashed', col='blue')
abline(h = 0, lty= 'dashed')
premija <- 5

plot(x,putsellPayoff(x,K,premija), type="l",lwd = 2, xlab = "Cena opcije", ylab = "Vrednost opcije", main = "Prodaja put opcije", xlim = c(-7,40))
abline(h = premija, lty= 'dashed', col='blue')
abline(h = 0, lty= 'dashed')
```

2. Na drugem koraku izbiramo le še med dvema možnostima. Odloèitev ali gre za nakupno ali put opcijo sprejmemo na podlagi velikosti napake, ki se pojavi pri aproksimaciji z eno ali z drugo kombinacijo premic. Izbiramo torej med kombinacijama:

* graf se priène z vodoravno premico in zvezno nadaljuje v premico z nenièelnim naklonom ali
* graf sestavlja premica z nenièelnim naklonom, ki preide v vodoravno premico.

Na ta naèin z enostavno primerjavo napak poišemo ustrezno obliko za aproksimacijo. 
Prišli smo do jedra algoritma v katerem **išèemo optimalno prileganje izbrane opcije na dane podatke**. Potrebno bo iskati najboljše prileganje obeh omenjenih premic. Premico z nenièelnim naklonom dobimo s pomoèjo **linearne regresije**, medtem ko vodoravno premico doloèimo preko **povpreèja profitov** na tistem delu podatkov, kjer opazimo stacionarnost. 


Opisani algoritem nam vrne:
```{r, echo=FALSE, eval=TRUE, results="markup", fig.align="center"}
opt_fit <- function(price, profit){
  if (cor(price, profit) < 0){
    #nakup put opcije (3) ali prodaja call opcije (2)
    
    #pogledamo napake odstopanj in odlocimo ali gre za put ali call
    meja <- length(price)/4
    povpr1 <- mean(profit[1:meja])
    er1 <- 0
    for (i in 1:meja){
      er1 <- er1 + (profit[i] - povpr1)^2}
    povpr1 <- mean(profit[(length(price)-meja):length(price)])
    er2 <- 0
    for (i in (length(price)-meja):length(price)){
      er2 <- er2 + (profit[i] - povpr1)^2}
    
    
    #1. NAKUP PUT OPCIJE__________________________________________________________
    if (er1 > er2){
      komentar <- paste("Gre za nakup put opcije.")
      print(komentar)
      
      odstopanje1 <- rep(0,length(price)) #odstopanje pri aproksimaciji z vodoravno premico
      odstopanje2 <- rep(0,length(price)) #odstopanje pri aproksimaciji z linearno regresijo (posevni del)
      najboljsi_K = 0
      
      
      #GLAVNA ZANKA
      for (K in 1:length(price)){
        #VODORAVNA PREMICA
        premica1 <- profit[K]
        napaka1 <- rep(0,length(price[K:length(profit)]))
        profiti <- profit[K:length(profit)]
        for (i in 1:length(napaka1)){
          napaka1[i] <- (((premica1 - profiti[i])^2))
        }
        odstopanje1[K] <- sum(napaka1)
        
        
        #POsEVNA PREMICA
        premica2 <- lm(profit[1:K] ~ price[1:K])
        odstopanje2[K] <- deviance(premica2)
        odstopanje2[K]
      }
      
      odstopanja <- odstopanje1 + odstopanje2
      
      najboljsi_K <- which(min(odstopanja) == odstopanja)
      premica1 <- mean(profit[najboljsi_K:length(profit)])
      abline(h = profit[najboljsi_K], col = 'red', lwd=2)
      premica2 <- lm(profit[1:najboljsi_K] ~ price[1:najboljsi_K])
      abline(premica2$coefficients[1],premica2$coefficients[2], col = 'dark blue',lwd=2)
      najboljsi_K
      #points(price[najboljsi_K], profit[najboljsi_K],type = "p", col = "green")
      
      strike_price = round(price[najboljsi_K],3)
      premija = abs(round(profit[najboljsi_K],3))
      kolièina = abs(round(premica2$coefficients[2],3))
      komentar <- paste("Priblizek za izvršilno ceno opcije je ", as.character(strike_price), " EUR/MWh,", " za kolièino ", as.character(kolièina), " MWh", " in za premijo ", as.character(premija), " EUR", ".",sep="")
      print(komentar)
      
    }
    
    #PRODAJA CALL OPCIJE__________________________________________________________
    
    if (er2 > er1){
      komentar <- paste("Gre za prodajo call opcije.")
      print(komentar)
      
      odstopanje1 <- rep(0,round(length(price)/2,0)) #odstopanje pri aproksimaciji z vodoravno premico
      odstopanje2 <- rep(0,round(length(price)/2,0)) #odstopanje pri aproksimaciji z linearno regresijo (posevni del)
      najboljsi_K = 0
      
      for (K in 1:round(length(price)/2,0)){
        #VODORAVNA PREMICA
        premica1 <- mean(profit[1:K])
        napaka1 <- rep(0,length(price[1:K]))
        for (i in 1:length(napaka1)){
          napaka1[i] <- (((premica1 - profit[i])^2))
        }
        odstopanje1[K] <- sum(napaka1)
        
        
        #POsEVNA PREMICA
        premica2 <- lm(profit[(round(length(price)/2,0)+K):length(price)] ~ price[(round(length(price)/2,0)+K):length(price)])
        odstopanje2[K] <- deviance(premica2)
        odstopanje2[K]
      }
      
      odstopanja <- odstopanje1 + odstopanje2
      najboljsi_K <- which(min(odstopanja) == odstopanja)
      premica1 <- profit[najboljsi_K]
      abline(h = profit[najboljsi_K], col = 'red', lwd=2)
      premica2 <- lm(profit[najboljsi_K:length(price)] ~ price[najboljsi_K:length(price)])
      abline(premica2$coefficients[1],premica2$coefficients[2], col = 'dark blue', lwd=2)
      najboljsi_K
      #points(price[najboljsi_K], profit[najboljsi_K],type = "p", col = "green")
      
      strike_price = round(price[najboljsi_K],3)
      premija = abs(round(profit[najboljsi_K],3))
      kolièina = abs(round(premica2$coefficients[2],3))
      komentar <- paste("Priblizek za izvršilno ceno opcije je ", as.character(strike_price), " EUR/MWh,", " za kolièino ", as.character(kolièina), " MWh", " in za premijo ", as.character(premija), " EUR", ".",sep="")
      print(komentar)
    }
  }
  
  if (cor(price, profit) > 0){
    #nakup call opcije ali prodaja put opcije
    
    meja <- length(price)/4
    povpr1 <- mean(profit[1:meja])
    er1 <- 0
    
    for (i in 1:meja){
      er1 <- er1 + (profit[i] - povpr1)^2
    }
    
    povpr1 <- mean(profit[(length(price)-meja):length(price)])
    er2 <- 0
    for (i in (length(price)-meja):length(price)){
      er2 <- er2 + (profit[i] - povpr1)^2
    }
    
    #PRODAJA PUT OPCIJE__________________________________________________________
    if (er1 > er2){
      komentar <- paste("Gre za prodajo put opcije.")
      print(komentar)
      
      #poiscimo optimalni fit
      odstopanje1 <- rep(0,round(length(price)/2,0)) #odstopanje pri aproksimaciji z vodoravno premico
      odstopanje2 <- rep(0,round(length(price)/2,0)) #odstopanje pri aproksimaciji z linearno regresijo (posevni del)
      najboljsi_K = 0
      
      
      for (K in 1:round(length(price)/2,0)){
        #VODORAVNA PREMICA
        premica1 <- mean(profit[(round(length(price)/2,0)+K):length(profit)])
        napaka1 <- rep(0,length(price[(round(length(price)/2,0)+K):length(profit)]))
        profiti <- profit[(round(length(price)/2,0)+K):length(profit)]
        for (i in 1:length(napaka1)){
          napaka1[i] <- (((premica1 - profiti[i])^2))
        }
        odstopanje1[K] <- sum(napaka1)
        
        
        #POsEVNA PREMICA
        premica2 <- lm(profit[1:K] ~ price[1:K])
        odstopanje2[K] <- deviance(premica2)
        odstopanje2[K]
      }
      
      odstopanja <- odstopanje1 + odstopanje2
      
      najboljsi_K <- which(min(odstopanja) == odstopanja)
      premica1 <- mean(profit[najboljsi_K:length(profit)])
      abline(h = profit[najboljsi_K], col = 'red', lwd=2)
      premica2 <- lm(profit[1:najboljsi_K] ~ price[1:najboljsi_K])
      abline(premica2$coefficients[1],premica2$coefficients[2], col = 'dark blue', lwd=2)
      najboljsi_K
      #points(price[najboljsi_K], profit[najboljsi_K],type = "p", col = "green")
      
      strike_price = round(price[najboljsi_K],3)
      premija = abs(round(profit[najboljsi_K],3))
      kolièina = abs(round(premica2$coefficients[2],3))
      komentar <- paste("Priblizek za izvršilno ceno opcije je ", as.character(strike_price), " EUR/MWh,", " za kolièino ", as.character(kolièina), " MWh", " in za premijo ", as.character(premija), " EUR", ".",sep="")
      print(komentar)
      
    }
    
    #NAKUP CALL OPCIJE__________________________________________________________
    if (er2 > er1){
      komentar <- paste("Gre za nakup call opcije.")
      print(komentar)
      
      odstopanje1 <- rep(0,round(length(price)/2,0)) #odstopanje pri aproksimaciji z vodoravno premico
      odstopanje2 <- rep(0,round(length(price)/2,0)) #odstopanje pri aproksimaciji z linearno regresijo (posevni del)
      najboljsi_K = 0
      
      for (K in 1:round(length(price)/2,0)){
        
        #VODORAVNA PREMICA
        premica1 <- mean(profit[1:K])
        napaka1 <- rep(0,length(price[1:K]))
        profiti <- profit[1:K]
        for (i in 1:length(napaka1)){
          napaka1[i] <- (((premica1 - profiti[i])^2))
        }
        odstopanje1[K] <- sum(napaka1)
        
        
        #POsEVNA PREMICA
        premica2 <- lm(profit[(round(length(price)/2,0)+K):length(price)] ~ price[(round(length(price)/2,0)+K):length(price)])
        odstopanje2[K] <- deviance(premica2)
        odstopanje2[K]
        
      }
      
      odstopanja <- odstopanje1 + odstopanje2
      najboljsi_K <- which(min(odstopanja) == odstopanja)
      premica1 <- profit[najboljsi_K]
      abline(h = profit[najboljsi_K], col = 'red', lwd=2)
      premica2 <- lm(profit[najboljsi_K:length(price)] ~ price[najboljsi_K:length(price)])
      abline(premica2$coefficients[1],premica2$coefficients[2], col = 'dark blue', lwd=2)
      #points(price[najboljsi_K], profit[najboljsi_K],type = "p", col = "green")
      
      
      strike_price = round(price[najboljsi_K],3)
      premija = abs(round(profit[najboljsi_K],3))
      kolièina = abs(round(premica2$coefficients[2],3))
      komentar <- paste("Priblizek za izvršilno ceno opcije je ", as.character(strike_price), " EUR/MWh,", " za kolièino ", as.character(kolièina), " MWh", " in za premijo ", as.character(premija), " EUR", ".",sep="")
      print(komentar)
      # 
      # rezultati <- data.frame(
      #   a <- c('strike price', 'kolièina', 'premija'),
      #   priblizki <- c(strike_price, kolièina, premija),
      #   stringsAsFactors = FALSE
      # )
      # colnames(rezultati) <- c('0','priblizki')
      # print(rezultati)
      
    }
  }
}
```

```{r, echo=FALSE, eval=TRUE, results="markup", fig.align="center",results='hide'}
#1. podatki, nakup put opcije
df <- read.csv("podatki.csv", sep=';', header = FALSE, stringsAsFactors=FALSE)
colnames(df) <- c('Price','Profit')
if (df$Price[2] > df$Price[3]){
  df <- df[order(df$Price),]} #podatke uredim po cene padajoce
df
price <- as.numeric(gsub(",", ".", df$Price))
profit <- as.numeric(gsub(",", ".", df$Profit))
```
```{r, echo=FALSE, eval=TRUE, results="markup", fig.align="center"}
#narisi graf
plot(x = price,
     y = profit,
     xlab = "Cena (v EUR/MWh)",
     ylab = "Profit (v EUR)",
     main = "Nakup put opcije",
     pch = 20, cex=1.5)
abline(h = 0, lty='dashed') #meja med poz in neg profiti

opt_fit(price,profit)
```


```{r, echo=FALSE, eval=TRUE, results="markup", fig.align="center", results='hide'}
#1. podatki, nakup put opcije
dfA <- read.csv("Naloga_A.csv", sep=';', header = TRUE, stringsAsFactors=FALSE)
colnames(dfA) <- c('Price','Profit')
dfA[order(dfA$Price),]
price <- as.numeric(gsub(",", ".", dfA$Price))
profit <- as.numeric(gsub(",", ".", dfA$Profit))
```

```{r, echo=FALSE, eval=TRUE, results="markup", fig.align="center"}
#narisi graf
plot(x = price,
     y = profit,
     xlab = "Cena (v EUR/MWh)",
     ylab = "Profit (v EUR)",
     main = "Nakup call opcije",
     pch = 20, cex=1.5)
abline(h = 0, lty='dashed')

opt_fit(price,profit)
```

```{r, echo=FALSE, eval=TRUE, results="markup", fig.align="center",results='hide'}
#3. podatki, nakup put opcije
dfB <- read.csv("Naloga_B.csv", sep=';', header = TRUE, stringsAsFactors=FALSE)
colnames(dfB) <- c('Price','Profit')

price <- as.numeric(gsub(",", ".", dfB$Price))
profit <- as.numeric(gsub(",", ".", dfB$Profit))

dfB <- data.frame(price,profit)
dfB <- dfB[order(dfB$price, decreasing = FALSE),]

price <- dfB$price
profit <- dfB$profit


```
```{r, echo=FALSE, eval=TRUE, results="markup", fig.align = 'center'}
#narisi graf
plot(x = price,
     y = profit,
     xlab = "Cena (v EUR/MWh)",
     ylab = "Profit (v EUR)",
     main = "Prodaja call opcije",
     pch = 20, cex=1.5)
abline(h = 0, lty='dashed')

opt_fit(price,profit)
```

```{r, echo=FALSE, eval=TRUE, results="markup", fig.align = 'center',results='hide'}
#4.. podatki, nakup put opcije
dfC <- read.csv("Naloga_C.csv", sep=';', header = TRUE, stringsAsFactors=FALSE)
colnames(dfC) <- c('Price','Profit')

price <- as.numeric(gsub(",", ".", dfC$Price))
profit <- as.numeric(gsub(",", ".", dfC$Profit))

dfC <- data.frame(price,profit)
dfC <- dfC[order(dfC$price,decreasing = FALSE),]

price <- dfC$price
profit <- dfC$profit
```

```{r, echo=FALSE, eval=TRUE, results="markup", fig.align = 'center'}
#narisi graf
plot(x = price,
     y = profit,
     xlab = "Cena (v EUR/MWh)",
     ylab = "Profit (v EUR)",
     main = "Nakup call opcije",
     pch = 20, cex=1.5)
abline(h = 0, lty='dashed')

opt_fit(price,profit)

```

<br>

<h3> 4. KOMENTARJI </h3>


<br>

<h3> 5. KODA </h3>
```{r, fig.align="center"}
opt_fit <- function(price, profit){
  if (cor(price, profit) < 0){
    #nakup put opcije (3) ali prodaja call opcije (2)
    
    #pogledamo napake odstopanj in odlocimo ali gre za put ali call
    meja <- length(price)/4
    povpr1 <- mean(profit[1:meja])
    er1 <- 0
    for (i in 1:meja){
      er1 <- er1 + (profit[i] - povpr1)^2}
    povpr1 <- mean(profit[(length(price)-meja):length(price)])
    er2 <- 0
    for (i in (length(price)-meja):length(price)){
      er2 <- er2 + (profit[i] - povpr1)^2}
    
    
    #1. NAKUP PUT OPCIJE__________________________________________________________
    if (er1 > er2){
      komentar <- paste("Gre za nakup put opcije.")
      print(komentar)
      
      odstopanje1 <- rep(0,length(price)) #odstopanje pri aproksimaciji z vodoravno premico
      odstopanje2 <- rep(0,length(price)) #odstopanje pri aproksimaciji z linearno regresijo (posevni del)
      najboljsi_K = 0
      
      
      #GLAVNA ZANKA
      for (K in 1:length(price)){
        #VODORAVNA PREMICA
        premica1 <- profit[K]
        napaka1 <- rep(0,length(price[K:length(profit)]))
        profiti <- profit[K:length(profit)]
        for (i in 1:length(napaka1)){
          napaka1[i] <- (((premica1 - profiti[i])^2))
        }
        odstopanje1[K] <- sum(napaka1)
        
        
        #POsEVNA PREMICA
        premica2 <- lm(profit[1:K] ~ price[1:K])
        odstopanje2[K] <- deviance(premica2)
        odstopanje2[K]
      }
      
      odstopanja <- odstopanje1 + odstopanje2
      
      najboljsi_K <- which(min(odstopanja) == odstopanja)
      premica1 <- mean(profit[najboljsi_K:length(profit)])
      abline(h = profit[najboljsi_K], col = 'red', lwd=2)
      premica2 <- lm(profit[1:najboljsi_K] ~ price[1:najboljsi_K])
      abline(premica2$coefficients[1],premica2$coefficients[2], col = 'dark blue',lwd=2)
      najboljsi_K
      #points(price[najboljsi_K], profit[najboljsi_K],type = "p", col = "green")
      
      strike_price = round(price[najboljsi_K],3)
      premija = round(profit[najboljsi_K],3)
      komentar <- paste("Priblizek za izvršilno ceno opcije je ", as.character(strike_price), ", za premijo pa ", as.character(premija), ".",sep="")
      print(komentar)
      
    }
    
    #PRODAJA CALL OPCIJE__________________________________________________________
    
    if (er2 > er1){
      komentar <- paste("Gre za prodajo call opcije.")
      print(komentar)
      
      odstopanje1 <- rep(0,length(price)) #odstopanje pri aproksimaciji z vodoravno premico
      odstopanje2 <- rep(0,length(price)) #odstopanje pri aproksimaciji z linearno regresijo (posevni del)
      najboljsi_K = 0
      
      for (K in 1:length(price)){
        #VODORAVNA PREMICA
        premica1 <- mean(profit[1:K])
        napaka1 <- rep(0,length(price[1:K]))
        for (i in 1:length(napaka1)){
          napaka1[i] <- (((premica1 - profit[i])^2))
        }
        odstopanje1[K] <- sum(napaka1)
        
        
        #POsEVNA PREMICA
        premica2 <- lm(profit[K:length(price)] ~ price[K:length(price)])
        odstopanje2[K] <- deviance(premica2)
        odstopanje2[K]
      }
      
      odstopanja <- odstopanje1 + odstopanje2
      najboljsi_K <- which(min(odstopanja) == odstopanja)
      premica1 <- profit[najboljsi_K]
      abline(h = profit[najboljsi_K], col = 'red', lwd=2)
      premica2 <- lm(profit[najboljsi_K:length(price)] ~ price[najboljsi_K:length(price)])
      abline(premica2$coefficients[1],premica2$coefficients[2], col = 'dark blue', lwd=2)
      najboljsi_K
      #points(price[najboljsi_K], profit[najboljsi_K],type = "p", col = "green")
      
      strike_price = round(price[najboljsi_K],3)
      premija = round(profit[najboljsi_K],3)
      komentar <- paste("Priblizek za izvršilno ceno opcije je ", as.character(strike_price), ", za premijo pa ", as.character(premija), ".",sep="")
      print(komentar)
    }
  }
  
  if (cor(price, profit) > 0){
    #nakup call opcije ali prodaja put opcije
    
    meja <- length(price)/4
    povpr1 <- mean(profit[1:meja])
    er1 <- 0
    
    for (i in 1:meja){
      er1 <- er1 + (profit[i] - povpr1)^2
    }
    
    povpr1 <- mean(profit[(length(price)-meja):length(price)])
    er2 <- 0
    for (i in (length(price)-meja):length(price)){
      er2 <- er2 + (profit[i] - povpr1)^2
    }
    
    #PRODAJA PUT OPCIJE__________________________________________________________
    if (er1 > er2){
      komentar <- paste("Gre za prodajo put opcije.")
      print(komentar)
      
      #poiscimo optimalni fit
      odstopanje1 <- rep(0,length(price)) #odstopanje pri aproksimaciji z vodoravno premico
      odstopanje2 <- rep(0,length(price)) #odstopanje pri aproksimaciji z linearno regresijo (posevni del)
      najboljsi_K = 0
      
      
      for (K in 1:length(price)){
        #VODORAVNA PREMICA
        premica1 <- mean(profit[K:length(profit)])
        napaka1 <- rep(0,length(price[K:length(profit)]))
        profiti <- profit[K:length(profit)]
        for (i in 1:length(napaka1)){
          napaka1[i] <- (((premica1 - profiti[i])^2))
        }
        odstopanje1[K] <- sum(napaka1)
        
        
        #POsEVNA PREMICA
        premica2 <- lm(profit[1:K] ~ price[1:K])
        odstopanje2[K] <- deviance(premica2)
        odstopanje2[K]
      }
      
      odstopanja <- odstopanje1 + odstopanje2
      
      najboljsi_K <- which(min(odstopanja) == odstopanja)
      premica1 <- mean(profit[najboljsi_K:length(profit)])
      abline(h = profit[najboljsi_K], col = 'red', lwd=2)
      premica2 <- lm(profit[1:najboljsi_K] ~ price[1:najboljsi_K])
      abline(premica2$coefficients[1],premica2$coefficients[2], col = 'dark blue', lwd=2)
      najboljsi_K
      #points(price[najboljsi_K], profit[najboljsi_K],type = "p", col = "green")
      
      strike_price = round(price[najboljsi_K],3)
      premija = round(profit[najboljsi_K],3)
      komentar <- paste("Priblizek za izvršilno ceno opcije je ", as.character(strike_price), ", za premijo pa ", as.character(premija), ".",sep="")
      print(komentar)
      
    }
    
    #NAKUP CALL OPCIJE__________________________________________________________
    if (er2 > er1){
      komentar <- paste("Gre za nakup call opcije.")
      print(komentar)
      
      odstopanje1 <- rep(0,length(price)) #odstopanje pri aproksimaciji z vodoravno premico
      odstopanje2 <- rep(0,length(price)) #odstopanje pri aproksimaciji z linearno regresijo (posevni del)
      najboljsi_K = 0
      
      for (K in 1:length(price)){
        
        #VODORAVNA PREMICA
        premica1 <- mean(profit[1:K])
        napaka1 <- rep(0,length(price[1:K]))
        profiti <- profit[1:K]
        for (i in 1:length(napaka1)){
          napaka1[i] <- (((premica1 - profiti[i])^2))
        }
        odstopanje1[K] <- sum(napaka1)
        
        
        #POsEVNA PREMICA
        premica2 <- lm(profit[K:length(price)] ~ price[K:length(price)])
        odstopanje2[K] <- deviance(premica2)
        odstopanje2[K]
        
      }
      
      odstopanja <- odstopanje1 + odstopanje2
      najboljsi_K <- which(min(odstopanja) == odstopanja)
      premica1 <- profit[najboljsi_K]
      abline(h = profit[najboljsi_K], col = 'red', lwd=2)
      premica2 <- lm(profit[najboljsi_K:length(price)] ~ price[najboljsi_K:length(price)])
      abline(premica2$coefficients[1],premica2$coefficients[2], col = 'dark blue', lwd=2)
      #points(price[najboljsi_K], profit[najboljsi_K],type = "p", col = "green")
      
      strike_price = round(price[najboljsi_K],3)
      premija = round(profit[najboljsi_K],3)
      komentar <- paste("Priblizek za izvršilno ceno opcije je ", as.character(strike_price), ", za premijo pa ", as.character(premija), ".",sep="")
      print(komentar)
      
    }
  }
}
```